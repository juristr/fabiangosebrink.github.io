<!DOCTYPE html>
<html>

<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    
    <title>Token Authentication with Claims and ASP.NET WebAPI</title>
     
    <meta name="description" content="Token Authentication with Claims and ASP.NET WebAPI" /> 

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico">

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400"
    />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />

     
    <meta property="og:site_name" content="Token Authentication with Claims and ASP.NET WebAPI" />
    
    
    
    <meta property="og:title" content="Token Authentication with Claims and ASP.NET WebAPI" />
    

    
     <meta property="og:url" content="http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/" />
    
    

    <meta property="og:type" content="article" />

    <meta property="og:description" content="Articles about Angular & ASP.NET" />
   
    <meta property="og:image" content="http://offering.solutions/assets/images/aerial-view-of-laptop-and-notebook_bw_osc.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
     
    <meta property="twitter:title" content="Token Authentication with Claims and ASP.NET WebAPI" />
    
    <meta name="twitter:description" content="Articles about Angular & ASP.NET" />

    
     <meta property="twitter:url" content="http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/" />
    
    <meta name="twitter:site" content="@FabianGosebrink" />
    <meta name="twitter:image" content="http://offering.solutions/assets/images/aerial-view-of-laptop-and-notebook_bw_osc.jpg" />


  
  <meta content="blog" property="article:section">
  


  
  <meta content="aspnet" property="article:tag">
  
  <meta content="authentication" property="article:tag">
  
  <meta content="authorization" property="article:tag">
  
  <meta content="claims" property="article:tag">
  
  <meta content="oauthprovider" property="article:tag">
  
  <meta content="roles" property="article:tag">
  


    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Offering Solutions",
    "url": "/",
    "image": "/assets/images/background.jpg",
    "description": "Articles about Angular & ASP.NET"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Offering Solutions" href="/feed.xml" />


</head>

<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-author " role="presentation"><a href="/author">Author</a></li>
        <li class="nav-courses " role="presentation"><a href="http://offering.solutions">Back to OS</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/aerial-view-of-laptop-and-notebook_bw_osc.jpg) ">
	
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/logo_small.png" alt="Blog Logo" /></a>
        <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
    </nav>
	
	
	    <!--   
			<div align="center">
				<h1>Token Authentication with Claims and ASP.NET WebAPI</h1>
			</div>
      -->
	
</header>

<main class="content" role="main">

    <article class="post tag-speeches">

        <header class="post-header">
            <h1 class="post-title">Token Authentication with Claims and ASP.NET WebAPI</h1>
            <section class="post-meta">
            <!-- <a href='/'>Fabian Gosebrink</a> -->
            <time class="post-date" datetime="2015-10-03">03 Oct 2015</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/tag/aspnet'>Aspnet</a>,
                       
                
                    
                       <a href='/tag/authentication'>Authentication</a>,
                       
                
                    
                       <a href='/tag/authorization'>Authorization</a>,
                       
                
                    
                       <a href='/tag/claims'>Claims</a>,
                       
                
                    
                       <a href='/tag/oauthprovider'>Oauthprovider</a>,
                       
                
                    
                       <a href='/tag/roles'>Roles</a>
                       
                
                 - 
                <span class="reading-time" title="Estimated read time">
  
  
    5 mins read
  
</span>
            </section>
        </header>

        <section class="post-content">

            <br/>
            <p>In this post I would like to show you the most simple example about TToken Authentication with Claims and ASP.NET WebAPI.</p>

<p>The sense behind this is:</p>

<ol>
  <li>We ask the Server for a token</li>
  <li>We receive the token, store it client side and…</li>
  <li>…send it in the header on every request</li>
</ol>

<p>The “problem” is that we do want to use all build in things Asp.Net WebAPI provides us. Microsoft serves us everything we need. So lets do this :)</p>

<p>First of all we configure our WebAPI to create a “controller” which is taking our requests. Here is the first unusual thing: The controller we create is kind of a virtual controller. We only provide it as a string.</p>

<figure class="highlight"><pre><code class="language-cs" data-lang="cs"><span class="n">OAuthOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">OAuthAuthorizationServerOptions</span>
    <span class="p">{</span>
        <span class="n">TokenEndpointPath</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PathString</span><span class="p">(</span><span class="s">"/Token"</span><span class="p">),</span>
        <span class="n">Provider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ApplicationOAuthProvider</span><span class="p">(),</span>
        <span class="n">AuthorizeEndpointPath</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PathString</span><span class="p">(</span><span class="s">"/api/Account/ExternalLogin"</span><span class="p">),</span>
        <span class="n">AccessTokenExpireTimeSpan</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromDays</span><span class="p">(</span><span class="m">14</span><span class="p">),</span>
        <span class="c1">//ONLY FOR DEVELOPING: ALLOW INSECURE HTTP!
</span>        <span class="n">AllowInsecureHttp</span> <span class="p">=</span> <span class="k">true</span>
    <span class="p">};</span>

<span class="c1">// Enable the application to use bearer tokens to authenticate users
</span><span class="n">app</span><span class="p">.</span><span class="nf">UseOAuthBearerTokens</span><span class="p">(</span><span class="n">OAuthOptions</span><span class="p">);</span></code></pre></figure>

<p>The “TokenEndpointPath” can be treated like a controller without really having one in your project. You will not find such a class there, so stop looking ;-) Other Properties speak for themselves. Well, now we have to take a look at the ApplicationOAuthProvider, we mentioned in the code, because this is a class which consumes the token request and gives us the token in the end.</p>

<p>Lets have a look at this.</p>

<figure class="highlight"><pre><code class="language-cs" data-lang="cs"><span class="k">public</span> <span class="k">class</span> <span class="nc">ApplicationOAuthProvider</span> <span class="p">:</span> <span class="n">OAuthAuthorizationServerProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ValidateClientAuthentication</span><span class="p">(</span><span class="n">OAuthValidateClientAuthenticationContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="nf">Validated</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">GrantResourceOwnerCredentials</span><span class="p">(</span><span class="n">OAuthGrantResourceOwnerCredentialsContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">OwinContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"*"</span> <span class="p">});</span>

        <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">UserName</span> <span class="p">!=</span> <span class="n">context</span><span class="p">.</span><span class="n">Password</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="nf">SetError</span><span class="p">(</span><span class="s">"invalid_grant"</span><span class="p">,</span> <span class="s">"The user name or password is incorrect."</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">identity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ClaimsIdentity</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">AuthenticationType</span><span class="p">);</span>
        <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="s">"sub"</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">UserName</span><span class="p">));</span>
        <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="p">,</span> <span class="s">"user"</span><span class="p">));</span>

        <span class="n">context</span><span class="p">.</span><span class="nf">Validated</span><span class="p">(</span><span class="n">identity</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The first line is a CORS-Line. You can get information about CORS looking <a href="http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api">here</a> or <a href="http://enable-cors.org/server_aspnet.html">here</a>.</p>

<p>ATTENTION: I am only comparing username and password here for equality. Normally you yould take your own User-Repository or the Asp.Net-Identity thing.</p>

<p>If everything is alright we can create a new identity and add claims to it.</p>

<p>Thats it! For server side.</p>

<p>But how to consume it?</p>

<p>So we have created the enpoint…lets request it with a POST-Request. (I am using Postman here)</p>

<p><img src="/assets/articles/wp-content/uploads/2015/10/1.jpg" alt="1" /></p>

<p>So send a post request to the token enpoint we created. Take a look at the “x-www-form-urlencoded” which is very important! Also see the “grant_type” which is set to “password”. Without this you will not reach the token endpoint. username and password are equal due to the fact we check it for equality in your OAuthProvider we introduced before.</p>

<p><img src="/assets/articles/wp-content/uploads/2015/10/2.jpg" alt="2" />
Also check that in the Headers-Section we set the content-type to “application/x-www-form-encoded”. Firing this request reaches the endpoint and is giving us a valid token:</p>

<p><img src="/assets/articles/wp-content/uploads/2015/10/31.jpg" alt="3" /></p>

<p>There you go. if we now copy this token and send it to a controller we tagged with the [authorize]-Attribute like this:</p>

<figure class="highlight"><pre><code class="language-cs" data-lang="cs"><span class="na">[Authorize]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ValuesController</span> <span class="p">:</span> <span class="n">ApiController</span>
<span class="p">{</span>
    <span class="c1">// GET api/&lt;controller&gt;
</span>    <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ClaimsIdentity</span> <span class="n">claimsIdentity</span> <span class="p">=</span> <span class="n">User</span><span class="p">.</span><span class="n">Identity</span> <span class="k">as</span> <span class="n">ClaimsIdentity</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">claims</span> <span class="p">=</span> <span class="n">claimsIdentity</span><span class="p">.</span><span class="n">Claims</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="n">type</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">Type</span><span class="p">,</span> <span class="k">value</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">Value</span> <span class="p">});</span>

        <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">claims</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><img src="/assets/articles/wp-content/uploads/2015/10/41.jpg" alt="Token Authentication with Claims and ASP.NET WebAPI" /></p>

<p>Note that we added the “Authorization”.Header with the “Bearer” and the token we just received. We can send it and receive the protected resource.</p>

<p>Thats it :)</p>

<p>You can also check the roles you added in the claims by just mentioning the roles in your Autorize-Attribute:</p>

<figure class="highlight"><pre><code class="language-cs" data-lang="cs"><span class="na">[Authorize(Roles = "user")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ValuesController</span> <span class="p">:</span> <span class="n">ApiController</span>
<span class="p">{</span>
    <span class="c1">// GET api/&lt;controller&gt;
</span>    <span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ClaimsIdentity</span> <span class="n">claimsIdentity</span> <span class="p">=</span> <span class="n">User</span><span class="p">.</span><span class="n">Identity</span> <span class="k">as</span> <span class="n">ClaimsIdentity</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">claims</span> <span class="p">=</span> <span class="n">claimsIdentity</span><span class="p">.</span><span class="n">Claims</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="n">type</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">Type</span><span class="p">,</span> <span class="k">value</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">Value</span> <span class="p">});</span>

        <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">claims</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The roles are added via claims in your OAuthProvider.</p>

<p>Hope this helps anybody.</p>

<p>Happy coding :)</p>

<p><a href="https://github.com/FabianGosebrink/ASPNET-WebAPI-TokenAuthentication">Github repository here</a></p>

<p>Fabian</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/" style="background-image: url(/assets/images/profile.jpg)"><span class="hidden">Fabian Gosebrink's Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/">Fabian Gosebrink</a></h4>
                
                
                    <p> Developing Software, Speaking & Teaching about ASP.NET & Angular</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> St. Gallen, Switzerland</span> 
                    <span class="author-link icon-link"><a href="http://fabian-gosebrink.com"> http://fabian-gosebrink.com</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Token Authentication with Claims and ASP.NET WebAPI&amp;url=http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'offeringsolutions'; // required: replace example with your forum shortname
        var disqus_identifier = '/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/';
        var disqus_url = 'http://offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/';
        //var disqus_url = 'offering.solutions/blog/articles/2015/10/03/token-authentication-with-claims-and-asp-net-webapi/';
 
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/aerial-view-of-laptop-and-notebook_bw_osc.jpg)" href="/blog/articles/2015/10/18/webhooks-with-asp-net-on-azure-dropbox-and-github/">
            <section class="post">
                <h2>WebHooks with ASP.NET on Azure - DropBox and GitHub</h2>
                <p>Hi, in this post I want to show you how to use ASP.NET-WebHooks with an...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/aerial-view-of-laptop-and-notebook_bw_osc.jpg)" href="/blog/articles/2015/09/02/webapi-with-asp-net-core-1-0-and-asp-net/">
            <section class="post">
                <h2>WebAPI with ASP.NET Core 1.0 and ASP.NET</h2>
                <p>I just released two sample APIs on Github: WebAPI with ASP.NET Core 1.0 and ASP.NET One...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="/">Offering Solutions</a> &copy; 2017</section>
            <section class="social-centered">&copy; Fabian Gosebrink
                <a class="social-icon" href="https://www.linkedin.com/in/fabian-gosebrink-71023a88"><i class="fa fa-linkedin-square" aria-hidden="true"></i></a>
                <a class="social-icon" href="https://github.com/FabianGosebrink"><i class="fa fa-github" aria-hidden="true"></i></a>
                <a class="social-icon" href="https://github.com/OfferingSolutions"><i class="fa fa-github" aria-hidden="true"></i></a>
                <a class="social-icon" href="https://mvp.microsoft.com/en-us/PublicProfile/5001666?fullName=Fabian%20%20Gosebrink"><i class="fa fa-windows" aria-hidden="true"></i></a>
                <a class="social-icon" href="https://www.xing.com/profile/Fabian_Gosebrink"><i class="fa fa-xing" aria-hidden="true"></i></a>
                <a class="social-icon" href="https://twitter.com/FabianGosebrink"><i class="fa fa-twitter" aria-hidden="true"></i></a>
            </section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>
    <script type="text/javascript" src="/assets/js/jekyll-search.js"></script>

    <script>
        SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: '/search.json',
        })
    </script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-91830658-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>

</html>